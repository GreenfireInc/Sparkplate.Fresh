# QR Code Export Fix - Direct Canvas Rendering

**Component:** `presentationStructure.ts`  
**Date:** December 24, 2025

## Overview

QR codes were not rendering properly in PNG and PDF exports. The solution was to replace html2canvas-based rendering with **direct Canvas API drawing**, following Greenery's proven approach from `drawQr.js` and `PaperWallet.js`.

---

## Problem Analysis

### Symptoms
- QR codes appeared blank or missing in exported PNG files
- QR codes appeared blank or missing in exported PDF files
- All other content (text, boxes) rendered correctly

### Root Cause

The original implementation used `html2canvas` to capture a DOM container that included `<img>` elements with QR code data URLs:

```typescript
// Original approach (problematic)
const addressImg = document.createElement("img");
addressImg.src = qrDataURL;  // Data URL
container.appendChild(addressImg);

// html2canvas tries to capture this...
const captured = await html2canvas(container, {...});
```

**html2canvas issues with data URL images:**
1. **Timing problems** - Images may not be fully painted when capture occurs
2. **CORS/taint issues** - Even with `useCORS: false`, data URLs can be problematic
3. **Offscreen rendering** - Elements positioned offscreen may not render properly
4. **Z-index visibility** - Elements with negative z-index may not be captured

---

## Solution

### Approach: Direct Canvas API Drawing

Following Greenery's implementation in:
- `Greenery/src/utils/canvas/drawQr.js`
- `Greenery/src/components/PaperWallet/utils/PaperWallet.js`
- `Greenery/src/components/dashboard/WalletModal.vue`

Instead of relying on html2canvas to capture DOM elements, draw everything directly onto a canvas using the Canvas 2D API.

### Implementation

**1. QR Code Drawing Function (from Greenery's drawQr.js pattern):**

```typescript
async function drawQRCode(
  ctx: CanvasRenderingContext2D,
  data: string,
  x: number,
  y: number,
  size: number
): Promise<void> {
  const QRCode = (await import("qrcode")).default;

  return new Promise((resolve, reject) => {
    QRCode.toDataURL(data, { width: size, margin: 1 }, (err, url) => {
      if (err) {
        reject(err);
        return;
      }
      const qrImage = new Image();
      qrImage.onerror = () => reject(new Error("Unable to load QR code image"));
      qrImage.src = url;
      qrImage.onload = () => {
        ctx.drawImage(qrImage, x, y, size, size);
        resolve();
      };
    });
  });
}
```

**2. Direct Canvas Creation:**

```typescript
const canvas = document.createElement("canvas");
canvas.width = EXPORT_WIDTH_PX * scale;
canvas.height = estimatedHeight * scale;

const ctx = canvas.getContext("2d");
ctx.scale(scale, scale);

// Draw background
ctx.fillStyle = "#ffffff";
ctx.fillRect(0, 0, EXPORT_WIDTH_PX, estimatedHeight);

// Draw QR codes directly onto canvas
await Promise.all([
  drawQRCode(ctx, crypto.address, qr1X, qrY, QR_SIZE_PX),
  drawQRCode(ctx, crypto.gpgPublicKey, qr2X, qrY, QR_SIZE_PX),
]);

// Draw text, boxes, etc.
ctx.fillText("Title", x, y);
ctx.fillRect(x, y, width, height);
```

**3. Export Functions:**

```typescript
export async function exportCryptoAsPNG(crypto: ExportCryptoAddress) {
  const canvas = await captureExportCanvas(crypto, { scale: 2 });
  const link = document.createElement("a");
  link.download = `${crypto.currency}-keys-${Date.now()}.png`;
  link.href = canvas.toDataURL("image/png");
  link.click();
}

export async function exportCryptoAsPDF(crypto: ExportCryptoAddress) {
  const canvas = await captureExportCanvas(crypto, { scale: 2 });
  const jsPDF = (await import("jspdf")).default;
  
  const pdf = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });
  pdf.addImage(canvas.toDataURL("image/png"), "PNG", 0, 0, imgWidth, imgHeight);
  pdf.save(`${crypto.currency}-keys-${Date.now()}.pdf`);
}
```

---

## Technical Details

### Why Direct Canvas Works Better

| Aspect | html2canvas | Direct Canvas API |
|--------|-------------|-------------------|
| QR Code Rendering | Unreliable timing | Guaranteed after `onload` |
| Image Loading | May miss async loads | Explicit `await` on load |
| DOM Dependencies | Requires DOM manipulation | Pure canvas operations |
| Performance | Parses/clones entire DOM | Direct draw commands |
| Reliability | Browser-dependent | Consistent across browsers |

### Greenery Reference Files

**`Greenery/src/utils/canvas/drawQr.js`:**
```javascript
QRCode.toDataURL(data, (err, url) => {
  const qrImage = new Image()
  qrImage.src = url
  qrImage.onload = () => {
    context.drawImage(qrImage, x, y, size, size)
    resolve()
  }
})
```

**`Greenery/src/components/PaperWallet/utils/PaperWallet.js`:**
```javascript
drawQRCode(content, position, size) {
  return new Promise((resolve, reject) => {
    QRCode.toDataURL(content, (err, url) => {
      const qrImage = new Image()
      qrImage.src = url
      qrImage.onload = () => {
        ctx.drawImage(qrImage, position[0], position[1], size, size)
        resolve(1)
      }
    })
  })
}
```

---

## Impact

### Before Fix
- ❌ QR codes blank in PNG exports
- ❌ QR codes blank in PDF exports
- ❌ html2canvas timing issues
- ❌ Inconsistent results across browsers

### After Fix
- ✅ QR codes render correctly in PNG exports
- ✅ QR codes render correctly in PDF exports
- ✅ Deterministic rendering with `await` on image load
- ✅ Consistent results across all browsers
- ✅ Faster export (no DOM parsing)

---

## Files Modified

- `src/exportStandard/presentationStructure.ts`:
  - Removed html2canvas dependency for QR code rendering
  - Added `drawQRCode()` function following Greenery's pattern
  - Rewrote `captureExportCanvas()` to use direct Canvas API
  - All text, boxes, and QR codes now drawn with `ctx.fillText()`, `ctx.fillRect()`, `ctx.drawImage()`
  - Retained jspdf for PDF generation (uses canvas output)

---

## Dependencies

- `qrcode` - QR code generation (existing)
- `jspdf` - PDF generation (existing)
- ~~`html2canvas`~~ - No longer used for QR code capture

---

## References

- Greenery `drawQr.js` implementation
- Greenery `PaperWallet.js` QR code rendering
- Canvas 2D API: `drawImage()`, `fillText()`, `fillRect()`
- QRCode.js `toDataURL()` callback pattern

