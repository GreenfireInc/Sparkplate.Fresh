# GPG Dynamic Import Fix - Module Load Timing

**Component:** `cryptoGenerator.ts`  
**Date:** November 18, 2025

## Overview

The previous approach failed because `openpgp.crypto.random` doesn't exist in OpenPGP.js v6's public API. The solution is to use **dynamic imports** to load OpenPGP.js AFTER patching `crypto.getRandomValues`, ensuring OpenPGP.js uses our deterministic RNG.

---

## Problem Analysis

### Error
```
TypeError: Cannot read properties of undefined (reading 'random')
at generateDeterministicGPG (cryptoGenerator.ts:130:58)
```

### Root Cause

1. **OpenPGP.js API Structure**: OpenPGP.js v6 doesn't expose `crypto.random.getRandomBytes` as a public API
2. **Module Load Timing**: Top-level imports execute before any of our code runs
3. **Function Capture**: OpenPGP.js captures `crypto.getRandomValues` during module initialization

---

## Solution

### Approach: Dynamic Import with Patching

1. **Remove top-level import**: Don't import OpenPGP.js at the module level
2. **Patch first**: Override `crypto.getRandomValues` with deterministic version
3. **Import dynamically**: Load OpenPGP.js after patching
4. **Generate key**: OpenPGP.js now uses patched version
5. **Restore**: Clean up patch after key generation

### Implementation

```typescript
// Remove from top of file:
// import * as openpgp from "openpgp";  ❌

// In generateDeterministicGPG():
// 1. Patch crypto.getRandomValues
crypto.getRandomValues = function(array: Uint8Array): Uint8Array {
  // Use deterministic PRNG
  const bytes = prng.syncBuffer.subarray(prng.syncOffset, prng.syncOffset + array.length);
  array.set(bytes);
  prng.syncOffset += array.length;
  return array;
};

// 2. Pre-fill buffer
prng.syncBuffer = await prng.getNextBytes(1048576);
prng.syncOffset = 0;

// 3. Dynamic import AFTER patching
const openpgp = await import("openpgp");

// 4. Generate key (uses patched crypto.getRandomValues)
const { privateKey, publicKey } = await openpgp.generateKey({...});

// 5. Restore
crypto.getRandomValues = originalGetRandomValues;
```

---

## Technical Details

### Module Caching

JavaScript modules are cached after first import. However, this works in our favor:

**First call:**
- Patch crypto.getRandomValues (points to prng1)
- Dynamic import openpgp (module loads and caches)
- Generate key (uses prng1)
- Restore crypto.getRandomValues

**Second call:**
- Patch crypto.getRandomValues (points to prng2 - fresh instance!)
- Dynamic import openpgp (returns cached module)
- Generate key (uses prng2 because crypto.getRandomValues was re-patched)
- Restore crypto.getRandomValues

**Key Insight:** Even though the module is cached, OpenPGP.js calls `crypto.getRandomValues` at runtime, not at module load. Each call patches it to point to a fresh PRNG instance.

### PRNG State Management

```typescript
class DeterministicPRNG {
  private counter: number;  // Always starts at 0
  private seed: Uint8Array;  // Derived from privateKey + currency
  public syncBuffer: Uint8Array;  // Pre-generated bytes
  public syncOffset: number;  // Position in buffer
  
  constructor(seed: Uint8Array) {
    this.counter = 0;  // Fresh state
  }
}
```

Each call to `generateDeterministicGPG`:
1. Creates NEW PRNG instance (counter = 0)
2. Generates fresh buffer from same seed
3. Same seed → same buffer → same keys

---

## Why This Works

1. **Timing Control**: We control when OpenPGP.js loads relative to our patching
2. **Runtime Patching**: Each call patches with a fresh PRNG instance
3. **Clean State**: No state leakage between calls
4. **Deterministic**: Same seed always produces same byte sequence

---

## Impact

### Before Fix
- ❌ Tried to access non-existent `openpgp.crypto.random` API
- ❌ TypeError crashes
- ❌ No key generation possible

### After Fix
- ✅ Uses dynamic imports to control timing
- ✅ Patches crypto.getRandomValues before OpenPGP.js uses it
- ✅ Fresh PRNG for each call
- ✅ Deterministic key generation
- ✅ Same fingerprint every time

---

## Files Modified

- `src/utils/cryptoGenerator.ts`:
  - Removed top-level `import * as openpgp`
  - Added dynamic `await import("openpgp")` in generateDeterministicGPG
  - Removed unused methods from DeterministicPRNG class
  - Added public syncBuffer and syncOffset for patching

---

## References

- JavaScript Dynamic Imports: ES2020 feature
- Module Caching: JavaScript Module System
- OpenPGP.js v6 Documentation

