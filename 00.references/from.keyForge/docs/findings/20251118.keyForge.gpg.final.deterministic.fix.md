# GPG Final Deterministic Fix - Function Capture Issue

**Component:** `cryptoGenerator.ts`  
**Date:** November 18, 2025

## Overview

The GPG key generation was still non-deterministic because OpenPGP.js **captures references to `crypto.getRandomValues` when the module loads**, before our runtime patching occurs. Our runtime patches had no effect on OpenPGP.js's internal random number generation.

---

## Problem Analysis

### Root Cause: Early Function Binding

1. **Module Load Time Capture**:
   - When `import * as openpgp from "openpgp"` runs, OpenPGP.js captures a reference to `crypto.getRandomValues`
   - This happens at module load time, before any of our code runs
   - Our runtime patching after module load has no effect

2. **Function Reference vs Property**:
   ```javascript
   // At module load (before our code):
   const capturedRandom = crypto.getRandomValues;
   
   // Later in our code (too late):
   crypto.getRandomValues = ourDeterministicRNG;
   
   // OpenPGP.js still uses capturedRandom, not our patched version!
   ```

3. **Timing Issue**:
   - Import happens: OpenPGP captures original functions
   - Our code runs: We try to patch the functions
   - OpenPGP generates key: Uses originally captured functions (not our patches)

---

## Solution

### Approach: Use OpenPGP.js's Internal Random API

OpenPGP.js v6+ provides access to its internal random number generator through the config system. We can override this directly:

```javascript
// Access OpenPGP's internal random function
openpgp.crypto.random.getRandomBytes = async (length) => {
  // Return our deterministic bytes
};
```

This works because we're replacing the actual function OpenPGP.js uses internally, not trying to patch global objects.

---

## Implementation

### Modified Approach

1. **Create PRNG with deterministic seed** (same as before)
2. **Override OpenPGP.js's internal random function** directly:
   ```javascript
   const originalGetRandomBytes = openpgp.crypto.random.getRandomBytes;
   openpgp.crypto.random.getRandomBytes = async (length) => {
     return await prng.getNextBytes(length);
   };
   ```
3. **Generate key** (OpenPGP now uses our deterministic function)
4. **Restore original function**

### Key Changes

- Remove crypto.getRandomValues patching (doesn't work)
- Remove Math.random patching (not needed)
- Remove Date.now patching (not needed)
- Use OpenPGP.js's internal API: `openpgp.crypto.random.getRandomBytes`

---

## Technical Details

### Why This Works

1. **Direct Function Replacement**:
   - We replace the actual function OpenPGP.js calls internally
   - No early binding issues
   - No captured references

2. **Async-Compatible**:
   - OpenPGP's `getRandomBytes` is async
   - Our PRNG's `getNextBytes` is async
   - Perfect match - no sync/async conversion needed

3. **Clean State**:
   - Each call creates fresh PRNG with counter = 0
   - Same seed → same sequence → same keys
   - No state leakage between calls

### Simplified Implementation

```typescript
// Create PRNG
const prng = new DeterministicPRNG(seedArray);

// Override OpenPGP's internal random function
const originalGetRandomBytes = openpgp.crypto.random.getRandomBytes;
openpgp.crypto.random.getRandomBytes = async (length) => {
  return await prng.getNextBytes(length);
};

try {
  // Generate key - uses our deterministic random
  const { privateKey, publicKey } = await openpgp.generateKey({...});
} finally {
  // Restore
  openpgp.crypto.random.getRandomBytes = originalGetRandomBytes;
}
```

---

## Impact

### Before Fix
- ❌ Runtime patching of crypto.getRandomValues didn't work
- ❌ OpenPGP.js used captured references to original functions
- ❌ Different fingerprints on each call
- ❌ Non-deterministic despite our efforts

### After Fix
- ✅ Direct replacement of OpenPGP's internal random function
- ✅ No early binding issues
- ✅ Same fingerprint every time
- ✅ Fully deterministic
- ✅ Much simpler code (no complex patching logic)

---

## Lessons Learned

1. **Module Load Order Matters**: Functions captured at module load time can't be patched later
2. **Use Library APIs**: When available, use library-provided extension points instead of global patching
3. **Simpler is Better**: Direct function replacement is cleaner than complex patching strategies

---

## Files Modified

- `src/utils/cryptoGenerator.ts`: Replaced global patching with direct OpenPGP.js internal API override

---

## References

- OpenPGP.js Internal APIs
- JavaScript Module Loading and Function Binding
- Deterministic Random Number Generation

