# Algorand NFD CORS Issue Fix

**Date**: October 9, 2025  
**Component**: `src/components/domains/algo.ts`, `vite.config.ts`  
**Issue**: CORS blocking NFD API calls from localhost  
**Status**: Fixed  

---

## Problem Summary

The NFD API was being blocked by CORS policy when called from `localhost:8080`:

```
Access to fetch at 'https://api.nf.domains/nfd/lookup?address=...' from origin 'http://localhost:8080' 
has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present on the requested resource.
```

---

## Root Cause

The NFD API (`api.nf.domains`) doesn't allow direct browser requests from localhost domains due to CORS restrictions. This is a security measure to prevent unauthorized cross-origin requests.

---

## Solution Implemented

### 1. Added Vite Proxy Configuration

**File**: `vite.config.ts`

Added proxy configuration to route NFD API requests through the Vite dev server:

```typescript
export default defineConfig(({ mode }) => ({
  server: {
    host: "::",
    port: 8080,
    proxy: {
      // Proxy NFD API requests to avoid CORS issues
      '/api/nfd': {
        target: 'https://api.nf.domains',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api\/nfd/, '/nfd'),
        secure: true,
      },
    },
  },
  // ... rest of config
}));
```

**How it works:**
- Requests to `/api/nfd/*` are proxied to `https://api.nf.domains/nfd/*`
- `changeOrigin: true` changes the origin header to match the target
- `rewrite` strips the `/api` prefix before forwarding to the API
- `secure: true` allows HTTPS targets

### 2. Updated API Base URL

**File**: `src/components/domains/algo.ts`

Changed the API base URL to use the proxy in development:

```typescript
// Before
const NFD_API_BASE = 'https://api.nf.domains/nfd';

// After
const NFD_API_BASE = import.meta.env.DEV ? '/api/nfd' : 'https://api.nf.domains/nfd';
```

**Behavior:**
- **Development** (`npm run dev`): Uses `/api/nfd` (proxied by Vite)
- **Production** (built app): Uses `https://api.nf.domains/nfd` (direct API)

### 3. Enhanced Endpoint Fallback

Also improved the reverse lookup to try multiple endpoints (similar to `Transact.tsx` pattern):

```typescript
const candidates = [
  `${NFD_API_BASE}/lookup?address=${address}&view=thumbnail`,
  `${NFD_API_BASE}/lookup?address=${address}&view=tiny&allowUnverified=true`,
  `${NFD_API_BASE}/v2/address?address=${address}`,
];
```

---

## How to Apply the Fix

### Step 1: Restart the Dev Server

The proxy configuration requires a server restart:

```bash
# Stop the current dev server (Ctrl+C)
# Then restart:
npm run dev
```

### Step 2: Test the Fix

1. Import an Algorand wallet via mnemonic
2. Check the browser console
3. You should see API calls to `/api/nfd/lookup` instead of `https://api.nf.domains/nfd/lookup`
4. No more CORS errors!

---

## Request Flow

### Before (CORS Error)

```
Browser (localhost:8080)
    ‚Üì fetch('https://api.nf.domains/nfd/lookup')
    ‚Üì
NFD API Server
    ‚Üì CORS check fails
    ‚Üì "No Access-Control-Allow-Origin header"
    ‚Üì
‚ùå CORS Error (blocked)
```

### After (With Proxy)

```
Browser (localhost:8080)
    ‚Üì fetch('/api/nfd/lookup')
    ‚Üì
Vite Dev Server (localhost:8080)
    ‚Üì proxies to https://api.nf.domains/nfd/lookup
    ‚Üì (origin header changed to api.nf.domains)
    ‚Üì
NFD API Server
    ‚Üì CORS check passes (same origin)
    ‚Üì returns data
    ‚Üì
Vite Dev Server
    ‚Üì forwards response
    ‚Üì
‚úÖ Browser receives data
```

---

## Production Considerations

### Why Different URLs for Dev/Prod?

- **Development**: Uses proxy to bypass CORS restrictions during local development
- **Production**: Once deployed, your app will be on a real domain (not localhost), and:
  - You may need to configure CORS on your server
  - OR host your app on a domain whitelisted by NFD
  - OR continue using a proxy in production

### Production Deployment Options

**Option 1: Deploy with Server Proxy**
```typescript
// Keep the proxy in production by detecting runtime environment
const NFD_API_BASE = window.location.hostname === 'localhost' 
  ? '/api/nfd' 
  : 'https://api.nf.domains/nfd';
```

**Option 2: Use Your Own API Backend**
- Create a backend API endpoint
- Your backend calls NFD API (no CORS issues server-to-server)
- Your frontend calls your backend

**Option 3: Request NFD API CORS Allowlist**
- Contact NFD team to allowlist your production domain
- Update to direct API calls

---

## Testing the Fix

### Console Output After Fix

You should see:

```
üîç [NF Domains] Starting reverse lookup for address: OGAS...
‚úÖ [NF Domains] Address validation passed
üîß [NF Domains] Trying multiple API endpoints...
üîß [NF Domains] Trying: /api/nfd/lookup
‚ÑπÔ∏è [NF Domains] Endpoint failed: HTTP 404
‚ÑπÔ∏è [NF Domains] No domain found for address after trying all endpoints
```

**Key difference**: 
- ‚úÖ No CORS error
- ‚úÖ API call completes (even if 404)
- ‚úÖ Graceful handling

---

## Related Files Modified

1. **`vite.config.ts`** - Added proxy configuration
2. **`src/components/domains/algo.ts`** - Updated API base URL

---

## Alternative Solutions Considered

### 1. CORS Browser Extension ‚ùå
- **Pros**: Quick fix for testing
- **Cons**: Only works for developer, not for users

### 2. Disable Browser Security ‚ùå
- **Pros**: Would allow requests
- **Cons**: Massive security risk, not a real solution

### 3. Server-Side Rendering ‚ùå
- **Pros**: No browser CORS issues
- **Cons**: Major architecture change

### 4. Vite Proxy ‚úÖ (Chosen)
- **Pros**: 
  - Simple configuration
  - Works for all developers
  - No code changes needed
  - Standard practice
- **Cons**: 
  - Requires server restart
  - Different behavior dev/prod (documented)

---

## Common Issues & Troubleshooting

### Issue: Still Getting CORS Error After Fix

**Solution**: Make sure you restarted the dev server:
```bash
# Stop server: Ctrl+C or Cmd+C
# Start again:
npm run dev
```

### Issue: 404 Instead of CORS Error

**Good news!** This means the proxy is working. The 404 just means the address doesn't have an NFD registered.

### Issue: Proxy Not Working

**Check:**
1. Vite config syntax is correct
2. Server restarted after changes
3. Browser cache cleared (Ctrl+Shift+R)

---

## References

- [Vite Server Proxy Docs](https://vitejs.dev/config/server-options.html#server-proxy)
- [CORS Explanation](https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS)
- [NFD API Documentation](https://api-docs.nf.domains/)

---

## Conclusion

The CORS issue has been resolved by adding a Vite proxy configuration. The NFD API is now accessible during development without CORS restrictions. Remember to restart your dev server to apply the changes!

**Status**: ‚úÖ **FIXED** - Restart dev server to apply

