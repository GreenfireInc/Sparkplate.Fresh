# Solana Name Service Reverse Lookup Misuse

**Date**: October 9, 2025  
**Component**: `src/components/domains/sol.ts`  
**Issue**: Incorrect usage of SNS reverse lookup causing wallet addresses to be returned as ".sol" domains  
**Severity**: High - Core functionality broken  

---

## Problem Summary

When providing a Solana private key/address to the domain resolver, the system returns an invalid domain like `6TkstqjeMjW2sXVv8KJ1TwCfMBTrmepXA7qsALS7VAhS.sol` instead of a human-readable domain name (e.g., `corey.sol`). This occurs because the current implementation misunderstands the fundamental difference between:
- **Domain Keys** (PublicKeys of domain registry accounts)
- **Wallet Addresses** (Owner PublicKeys)

---

## Root Cause Analysis

### The Core Misunderstanding

The `reverseLookup()` function from `@bonfida/spl-name-service` is being used incorrectly:

**What `reverseLookup` ACTUALLY does:**
```typescript
// From: sns-sdk-main/js/src/utils/reverseLookup.ts
export async function reverseLookup(
  connection: Connection,
  nameAccount: PublicKey,  // <-- This is a DOMAIN KEY, not a wallet address!
  parent?: PublicKey,
): Promise<string>
```

- **Input**: A domain registry account PublicKey (domain key)
- **Output**: The human-readable name for that specific domain
- **Purpose**: Converts a domain key to its human-readable name

**Example:**
```typescript
// Domain Key: abc123xyz... (PublicKey of the "corey.sol" domain registry)
// Result: "corey" (without .sol extension)
```

### What We're Actually Trying to Do

We want to find human-readable domains **owned by** a wallet address, which requires:

1. **Getting the favorite/primary domain** for a wallet (recommended approach)
2. **OR** getting all domains owned by a wallet, then reverse-looking up each one

---

## Correct Implementation Patterns

### Pattern 1: Get Favorite Domain (Primary Domain)

This is the **recommended** approach - gets the user's designated favorite domain:

```typescript
// From: sns-sdk-main/js/src/favorite-domain.ts
import { getFavoriteDomain } from '@bonfida/spl-name-service';

export const getFavoriteDomain = async (
  connection: Connection,
  owner: PublicKey,  // <-- This is a WALLET ADDRESS
) => {
  const [favKey] = FavouriteDomain.getKeySync(
    NAME_OFFERS_ID,
    new PublicKey(owner),
  );
  const favorite = await FavouriteDomain.retrieve(connection, favKey);
  const { registry, nftOwner } = await NameRegistryState.retrieve(
    connection,
    favorite.nameAccount,  // <-- This is the DOMAIN KEY
  );
  const domainOwner = nftOwner || registry.owner;

  // Now we use reverseLookup on the DOMAIN KEY, not the wallet address
  let reverse = await reverseLookup(
    connection,
    favorite.nameAccount,  // <-- Domain key
    registry.parentName.equals(ROOT_DOMAIN_ACCOUNT)
      ? undefined
      : registry.parentName,
  );

  if (!registry.parentName.equals(ROOT_DOMAIN_ACCOUNT)) {
    const parentReverse = await reverseLookup(connection, registry.parentName);
    reverse += `.${parentReverse}`;
  }

  return {
    domain: favorite.nameAccount,  // Domain key
    reverse,                        // Human-readable name (e.g., "corey")
    stale: !owner.equals(domainOwner),
  };
};
```

### Pattern 2: Get All Domains Owned by Wallet

Alternative approach - gets all domains owned by the wallet:

```typescript
// From: sns-sdk-main/js/src/utils/getAllDomains.ts
import { getAllDomains, reverseLookup } from '@bonfida/spl-name-service';

export async function getAllDomainsForWallet(
  connection: Connection,
  wallet: PublicKey,  // <-- Wallet address
): Promise<PublicKey[]> {
  // Get all domain KEYS owned by this wallet
  const domainKeys = await getAllDomains(connection, wallet);
  
  // Now use reverseLookup on each domain key
  for (const domainKey of domainKeys) {
    const humanReadableName = await reverseLookup(connection, domainKey);
    console.log(`Domain: ${humanReadableName}.sol`);
  }
  
  return domainKeys;
}
```

### Pattern 3: HTTP API Approach (No RPC Rate Limits)

The Bonfida SNS SDK provides an HTTP API that avoids RPC rate limiting:

```typescript
// From: sns-sdk-main/cf-worker/src/index.ts (lines 289-309)
// Endpoint: https://sns-sdk-proxy.bonfida.workers.dev/favorite-domain/:owner

app.get("/favorite-domain/:owner", async (c) => {
  const { owner } = c.req.param();
  const res = await getFavoriteDomain(
    getConnection(c, rpc),
    new PublicKey(owner)  // <-- Wallet address
  );
  return c.json(
    response(true, { 
      domain: res.domain.toBase58(),  // Domain key as base58 string
      reverse: res.reverse             // Human-readable name
    })
  );
});

// If no favorite domain exists, returns:
// { s: "ok", result: null }

// On error: 
// { s: "error", result: "Invalid domain input" }
```

**Response format:**
```json
{
  "s": "ok",
  "result": {
    "domain": "9ZNTfG4NyQgxy2SWjSiQoUyBPEvXT2xo7fKc5hPYYJ7b",
    "reverse": "corey"
  }
}
```

---

## Issues in Current Implementation

### Issue 1: HTTP API Response Parsing

**Location**: `sol.ts` lines 144-166

The current code checks for multiple response formats but **misses the correct format**:

```typescript
// Current code checks:
// Format 1: data.result.domain
// Format 2: data.result.reverse
// Format 3: data.domain
// Format 4: data.reverse
// Format 5: Direct string

// MISSING: The actual format is data.result (object) with both fields!
```

**Correct format** from the API:
```typescript
if (data && data.s === 'ok' && data.result) {
  if (data.result === null) {
    // No favorite domain set
    console.log('No favorite domain found');
  } else {
    // data.result.domain = domain key
    // data.result.reverse = human-readable name
    const domainName = data.result.reverse;  // <-- This is the correct field
    const fullDomain = `${domainName}.sol`;
  }
}
```

### Issue 2: RPC Fallback Logic

**Location**: `sol.ts` lines 186-260

The RPC fallback correctly uses `getFavoriteDomain` and `getAllDomains`, but the HTTP API parsing prevents it from ever being reached when the API returns a valid response in the wrong format.

---

## Recommended Fix

### Step 1: Fix HTTP API Response Parsing

```typescript
// Strategy 1: Try SNS HTTP API first (no RPC rate limits)
console.log(`ðŸ” [Solana Name Service] Trying SNS HTTP API...`);
try {
  const apiUrl = `https://sns-sdk-proxy.bonfida.workers.dev/favorite-domain/${address}`;
  const response = await fetch(apiUrl, {
    method: 'GET',
    headers: {
      'Accept': 'application/json',
    },
  });

  if (response.ok) {
    const data = await response.json();
    console.log(`ðŸ” [Solana Name Service] API response:`, data);
    
    // Check for correct response format
    if (data && data.s === 'ok') {
      if (data.result === null) {
        // No favorite domain set for this address
        console.log(`â„¹ï¸ [Solana Name Service] No favorite domain set for ${address}`);
        // Fall through to RPC methods
      } else if (data.result && typeof data.result === 'object') {
        // Correct format: { s: "ok", result: { domain: "key", reverse: "name" } }
        const domainName = data.result.reverse;
        if (domainName && typeof domainName === 'string') {
          const fullDomain = domainName.endsWith('.sol') 
            ? domainName 
            : `${domainName}.sol`;
          console.log(`âœ… [Solana Name Service] Found domain via HTTP API: ${address} â†’ ${fullDomain}`);
          return fullDomain;
        }
      }
    }
  }
} catch (apiError) {
  console.log(`â„¹ï¸ [Solana Name Service] HTTP API failed:`, apiError);
}
```

### Step 2: Keep RPC Fallback (Already Correct)

The existing RPC fallback logic is actually correct! It properly uses:
1. `getFavoriteDomain` (lines 203-220)
2. `getAllDomains` + `reverseLookup` (lines 222-241)

---

## Key Concepts to Remember

### Domain Key vs Wallet Address

| Concept | Description | Example |
|---------|-------------|---------|
| **Wallet Address** | The owner's public key | `6TkstqjeMjW2sXVv8KJ1TwCfMBTrmepXA7qsALS7VAhS` |
| **Domain Key** | PublicKey of a domain registry account | `9ZNTfG4NyQgxy2SWjSiQoUyBPEvXT2xo7fKc5hPYYJ7b` |
| **Human-Readable Name** | The actual .sol domain name | `corey.sol` |

### Function Purpose Matrix

| Function | Input Type | Output Type | Purpose |
|----------|------------|-------------|---------|
| `resolve()` | Human-readable name | Wallet address | Domain â†’ Owner |
| `reverseLookup()` | Domain key | Human-readable name | Domain Key â†’ Name |
| `getFavoriteDomain()` | Wallet address | {domain key, reverse name, stale} | Owner â†’ Favorite Domain |
| `getAllDomains()` | Wallet address | Array of domain keys | Owner â†’ All Domains |

---

## Testing Recommendations

### Test Case 1: Address with Favorite Domain

```typescript
const address = "HKKp49qGWXd639QsuH7JiLijfVW5UtCVY4s1n2HANwEA"; // bonfida.sol owner
const result = await resolveDomainForAddress(address);
// Expected: "bonfida.sol"
// Currently getting: "HKKp49qGWXd639QsuH7JiLijfVW5UtCVY4s1n2HANwEA.sol" âŒ
```

### Test Case 2: Address without Favorite Domain

```typescript
const address = "11111111111111111111111111111111"; // System program
const result = await resolveDomainForAddress(address);
// Expected: null
// Currently getting: "11111111111111111111111111111111.sol" âŒ
```

### Test Case 3: Address with Multiple Domains

```typescript
// User owns: alice.sol, bob.sol, charlie.sol
// Favorite set to: bob.sol
const result = await resolveDomainForAddress(address);
// Expected: "bob.sol" (their favorite)
// With getAllDomains fallback: "alice.sol" (first found)
```

---

## Additional Resources

### Official Documentation
- [Bonfida SNS Documentation](https://docs.bonfida.org/collection/v/name-service/)
- [SNS SDK GitHub](https://github.com/Bonfida/sns-sdk)

### Key Source Files Referenced
- `sns-sdk-main/js/src/favorite-domain.ts` - getFavoriteDomain implementation
- `sns-sdk-main/js/src/utils/reverseLookup.ts` - reverseLookup implementation
- `sns-sdk-main/js/src/utils/getAllDomains.ts` - getAllDomains implementation
- `sns-sdk-main/cf-worker/src/index.ts` - HTTP API endpoints

---

## Implementation Priority

1. **Critical**: Fix HTTP API response parsing to correctly extract `data.result.reverse`
2. **Important**: Add proper null handling for addresses without domains
3. **Enhancement**: Add better logging to distinguish between API/RPC failures and "no domain found"
4. **Enhancement**: Consider caching favorite domain lookups to reduce API calls

---

## Conclusion

The core issue is a misunderstanding of the SNS API architecture:
- `reverseLookup()` is NOT for converting wallet addresses to domains
- `reverseLookup()` is for converting domain keys to human-readable names
- Use `getFavoriteDomain()` to get a wallet's favorite domain
- Use `getAllDomains()` + `reverseLookup()` to get all domains owned by a wallet

The HTTP API response parsing needs correction, but the RPC fallback logic is already implemented correctly.

