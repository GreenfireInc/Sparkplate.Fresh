# Polkadot Keystore File Types Analysis

**Date:** September 1, 2025  
**Author:** Claude (Assistant)  
**Context:** Analysis of different Polkadot keystore file formats in loginStandard project

## Overview

This document analyzes the different types of Polkadot keystore files found in the project's reference folder and their structural differences, encryption methods, and decryption processes.

## Keystore File Types

### 1. Standard Single Account PKCS#8 Keystores

**Structure:**
```json
{
  "encoded": "base64-encoded-encrypted-data",
  "encoding": {
    "content": ["pkcs8", "sr25519"],
    "type": ["scrypt", "xsalsa20-poly1305"],
    "version": "3"
  },
  "address": "SS58-encoded-address",
  "meta": {
    "name": "Account Name"
  }
}
```

**Examples:**
- `Exodus.json` - Address: `5CcEfDpDkMfmx4TtKH2XFBUWcSsF6Ej3KyQs85MWPB9gfR6g`
- `Chromium.json` - Address: `5DUW7D2Sy5Sog7Wewu4YXioQQtdtJEaaqGkf89VF9B9Uvt1b`
- `5CcEfDpDkMfmx4TtKH2XFBUWcSsF6Ej3KyQs85MWPB9gfR6g.DOT.Polkadot.Exodus.json`

**Characteristics:**
- Single layer encryption
- Direct PKCS#8 encrypted private key
- File size: ~548-550 bytes
- Simple metadata structure

### 2. Batch Export (batch-pkcs8) Keystores

**Structure:**
```json
{
  "encoded": "base64-encoded-encrypted-json-string",
  "encoding": {
    "content": ["batch-pkcs8"],
    "type": ["scrypt", "xsalsa20-poly1305"],
    "version": "3"
  },
  "accounts": [
    {
      "address": "SS58-encoded-address",
      "meta": {
        "genesisHash": "",
        "name": "Account Name",
        "isMasterAccount": true,
        "whenCreated": 1756774072391,
        "isMasterPassword": true,
        "isSubWallet": true
      }
    }
  ]
}
```

**Examples:**
- `batch_export_1756774961996.json`
- `batch_export_1756774155476.json`
- `batch_export_1756677317967.json`

**Characteristics:**
- Two-layer encryption structure
- Contains multiple accounts in single file
- File size: ~1.2KB+
- Rich metadata with timestamps and flags

## Key Differences

### Encryption Structure

| Type | Encryption Layers | Content Structure |
|------|------------------|-------------------|
| **Standard PKCS#8** | Single layer | Direct PKCS#8 encrypted private key |
| **batch-pkcs8** | **Two layers** | 1. Outer: Encrypted JSON array<br/>2. Inner: Individual PKCS#8 keystores |

### Decryption Process

**Standard PKCS#8 Decryption:**
```typescript
const keyring = new Keyring({ type: 'sr25519' });
const pair = keyring.addFromJson(keystoreObj);
pair.decodePkcs8(password);
const publicKey = pair.publicKey;
```

**batch-pkcs8 Decryption (Two-Step Process):**
```typescript
// Step 1: Decrypt outer layer to get JSON string
const innerJsonString = u8aToString(jsonDecrypt(batchKeystore, password));

// Step 2: Parse to get array of individual keystores
const innerKeystores = JSON.parse(innerJsonString);

// Step 3: Decrypt each individual keystore using same password
const keyring = new Keyring({ type: 'sr25519' });
const pair = keyring.addFromJson(innerKeystores[0]);
pair.decodePkcs8(password);
const publicKey = pair.publicKey;
```

### Identification

**Detection Logic:**
```typescript
const isBatchExport = keystoreData.encoding?.content?.includes('batch-pkcs8');

if (isBatchExport) {
  // Use two-step batch decryption
  return await decryptBatchKeystore(keystoreData, password);
} else {
  // Use standard single-account decryption
  return await decryptSingleAccount(keystoreData, password);
}
```

## Cryptographic Security

Both formats use identical encryption standards:
- **Key Derivation Function:** `scrypt` (memory-hard, resistant to hardware attacks)
- **Encryption Algorithm:** `xsalsa20-poly1305` (authenticated encryption)
- **Format Version:** `"3"` (current Polkadot.js standard)
- **Cryptographic Scheme:** `sr25519` (Schnorr signatures on Ristretto)

## Use Cases

| Type | Created By | Primary Purpose |
|------|------------|-----------------|
| **Standard PKCS#8** | Individual wallet exports, manual exports | Single account backup/transfer |
| **batch-pkcs8** | Wallet bulk export features (SubWallet, Talisman, etc.) | Multiple accounts backup/migration |

## Implementation Notes

### Critical Implementation Details

1. **Same Password for Both Layers:** In batch-pkcs8 files, the same password is used for both the outer batch encryption and the inner individual keystore encryption.

2. **Standard Polkadot.js Compatibility:** Both formats are fully compatible with the standard Polkadot.js keyring library methods.

3. **Dynamic Crypto Type Detection:** The crypto type (`sr25519`, `ed25519`, `ecdsa`) should be detected from `encoding.content[1]` for proper keyring initialization.

### Common Pitfalls

1. **Manual PKCS#8 Parsing:** Attempting to manually parse PKCS#8 structures is unnecessary and error-prone. The standard Polkadot.js approach works reliably.

2. **Hardcoded Crypto Types:** Always detect the crypto type from the keystore metadata rather than assuming `sr25519`.

3. **Password Reuse:** In batch files, don't prompt for a second password - the same password decrypts both layers.

## Testing Results

All keystore types have been successfully tested and validated:

- ✅ `Exodus.json` with password `@August#2o25!`
- ✅ `Chromium.json` with password `@September#2o25!`
- ✅ `batch_export_1756774961996.json` with password `@September#2o25!`
- ✅ Generates correct public keys and SS58 addresses for all network prefixes

## Conclusion

The loginStandard project now successfully handles both standard PKCS#8 and batch-pkcs8 Polkadot keystore formats through a unified interface that:

1. **Automatically detects** the keystore type based on `encoding.content`
2. **Routes appropriately** to single-account or batch decryption logic
3. **Uses standard Polkadot.js methods** for reliable, secure decryption
4. **Generates accurate addresses** for Polkadot (prefix 0), Kusama (prefix 2), and Substrate (prefix 42) networks

This comprehensive support ensures compatibility with keystores exported from major Polkadot wallets including SubWallet, Talisman, Exodus, and others.
