# Polkadot Method Toggle & ETH Address Display Fix

**Date:** October 6, 2025  
**Branch:** CS.PrivateKey.Importing.Pass.8Eight  
**Status:** ‚úÖ **FIXED**

---

## Issues Reported

1. **Method Toggle Not Working:** When importing Polkadot keystores, the import method toggle (auto/polkadotjs/exodus) appeared to have no effect
2. **ETH Address Not Showing:** Ethereum addresses weren't displaying properly in the multi-format address component

---

## Root Causes

### Issue 1: Method Toggle
**Problem:** Keystore imports return a public key (marked with `PKCS8_PUB:`), but the router wasn't consistently enforcing that keystore public keys MUST always use SR25519, regardless of the method toggle setting.

**Why it matters:** 
- Keystore public keys are extracted using SR25519 cryptography
- Attempting to process them with ED25519 would generate incorrect addresses
- The method toggle should only affect raw private key imports, not keystore imports

**Previous behavior:**
```typescript
// User imports keystore ‚Üí gets PKCS8_PUB:xxx
// User toggles to 'exodus' ‚Üí router strips marker and routes to ED25519
// Result: Wrong addresses generated ‚ùå
```

### Issue 2: ETH Address Display
**Problem:** When keystore files are imported, Ethereum addresses cannot be derived because you need the private key, not just the public key. However, this wasn't clearly communicated to users.

**Why it matters:**
- Ethereum addresses require the full private key to derive
- Keystore decryption only exposes the public key for security
- Users were confused why ETH sometimes showed and sometimes didn't

---

## Solutions Implemented

### Fix 1: Router Logic Update

**File:** `src/components/currencies/ext.DOT.Polkadot/router.DOT.Polkadot.ts`

**Change:** Added early detection and routing for keystore public keys BEFORE method selection logic:

```typescript
// Check for keystore public key marker
if (privateKey.startsWith('PKCS8_PUB:')) {
  isKeystorePublicKey = true;
  cleanPrivateKey = privateKey.replace('PKCS8_PUB:', '');
  console.log('‚ö†Ô∏è [ROUTER] Keystore public keys always use SR25519, ignoring method selection');
}

// IMPORTANT: Keystore public keys MUST use SR25519 regardless of method selection
// This is because the public key was extracted from a keystore using SR25519
if (isKeystorePublicKey) {
  console.log('üîÑ [ROUTER] Keystore public key detected - routing to SR25519');
  console.log('üì¶ Using: DOT.Polkadot.sr25519 (standard Polkadot keystore approach)');
  return await polkadotSr25519Data.deriveFromPrivateKey(cleanPrivateKey);
}

// Route based on selected method (for raw private keys only)
if (method === 'polkadotjs') {
  // ...
}
```

**Result:** 
- ‚úÖ Keystore imports ALWAYS use SR25519, regardless of toggle
- ‚úÖ Raw private key imports respect the method toggle
- ‚úÖ Correct addresses generated in all scenarios

### Fix 2: UI Feedback for Method Toggle

**File:** `src/components/accessControl/authentication/loginStandard/options/TemporaryKeyModal.tsx`

**Change:** Added informational message when keystore is imported:

```typescript
{/* Polkadot Import Method Toggle */}
{ticker === "DOT" && (
  <div className="mt-4">
    <div className="flex items-center justify-start gap-3 px-1">
      <Label className="text-sm text-black font-medium">Import Method:</Label>
      <ImportGenerationStyle
        value={polkadotImportMethod}
        onChange={setPolkadotImportMethod}
      />
    </div>
    {/* Show note if keystore was imported */}
    {privateKeyInput.startsWith('PKCS8_PUB:') && (
      <div className="mt-2 px-1 text-xs text-gray-600 dark:text-gray-400">
        ‚ÑπÔ∏è Keystore imports always use the standard Polkadot.js method. 
        Import method selection only applies to raw private keys.
      </div>
    )}
  </div>
)}
```

**Result:**
- ‚úÖ Users see clear explanation when toggle has no effect
- ‚úÖ Reduced confusion about why method selection doesn't change keystore results

### Fix 3: ETH Address Availability Note

**File:** `src/components/currencies/ext/multiFormatAddresses.tsx`

**Change:** Added note explaining when Ethereum addresses are available:

```typescript
// Check if ETH address is missing (indicates keystore import)
const hasEthAddress = networkInfo.formattedDisplay.includes('ETH://');
const isKeystoreImport = !hasEthAddress && networkInfo.formattedDisplay.includes('DOT://');

return (
  <div className={`mt-4 p-3 bg-gray-50 dark:bg-gray-800 rounded-lg ${className}`}>
    <div className="text-xs text-gray-600 dark:text-gray-400 mb-2">
      Multi-network addresses:
      {isKeystoreImport && (
        <span className="ml-2 text-gray-500 dark:text-gray-500 italic">
          (Ethereum address requires raw private key)
        </span>
      )}
    </div>
    {/* ... address display ... */}
  </div>
);
```

**Result:**
- ‚úÖ Users understand why ETH address isn't showing for keystore imports
- ‚úÖ Clear indication that ETH requires the full private key
- ‚úÖ No confusion about "missing" addresses

---

## Behavior Matrix

### Keystore Import (Public Key Only)

| Method Toggle | Module Used | ETH Address | Notes |
|--------------|-------------|-------------|-------|
| **auto** | SR25519 | ‚ùå Not available | Public key only, cannot derive ETH |
| **polkadotjs** | SR25519 | ‚ùå Not available | Forced to SR25519 regardless of toggle |
| **exodus** | SR25519 | ‚ùå Not available | Forced to SR25519 regardless of toggle |

**UI Message:** "‚ÑπÔ∏è Keystore imports always use the standard Polkadot.js method. Import method selection only applies to raw private keys."

### Raw Private Key Import (Full Private Key)

| Method Toggle | Module Used | ETH Address | Notes |
|--------------|-------------|-------------|-------|
| **auto** | ED25519 | ‚úÖ Available | Auto-detects raw private key |
| **polkadotjs** | SR25519 | ‚úÖ Available | User forces SR25519 derivation |
| **exodus** | ED25519 | ‚úÖ Available | User forces ED25519 derivation |

**UI Message:** (none - toggle works as expected)

---

## Technical Details

### Why Keystore Public Keys Must Use SR25519

1. **Keystore Structure:**
   - Polkadot keystores store encrypted private key material
   - Decryption exposes the public key using SR25519 cryptography
   - The keystore metadata specifies which crypto type was used

2. **Public Key Extraction:**
   ```typescript
   // In DOT.Polkadot.sr25519.Standard.ts
   const cryptoType = keystoreObj.encoding.content[1]; // Usually 'sr25519'
   const keyring = new Keyring({ type: cryptoType });
   const pair = keyring.addFromJson(keystoreObj);
   pair.decodePkcs8(password);
   const publicKeyHex = u8aToHex(pair.publicKey).slice(2);
   return `PKCS8_PUB:${publicKeyHex}`; // Marked as keystore-derived
   ```

3. **Why Not ED25519:**
   - Public keys from SR25519 keystores aren't compatible with ED25519 address generation
   - Attempting to process SR25519 public keys with ED25519 produces incorrect addresses
   - The crypto type used for extraction MUST match the type used for address generation

### Why ETH Address Requires Private Key

1. **Ethereum Address Derivation:**
   ```typescript
   // Requires full 32-byte private key
   const ethereumWallet = new Wallet(`0x${privateKey}`);
   const ethereumAddress = ethereumWallet.address;
   ```

2. **Security Limitation:**
   - Keystore decryption only exposes the public key
   - Full private key remains encrypted for security
   - Cannot derive Ethereum address without the private key

3. **Detection Logic:**
   ```typescript
   if (inputType === 'raw_private_key') {
     // Full private key available
     ethereumAddress = new Wallet(`0x${privateKey}`).address;
   } else {
     // Public key only (from keystore)
     ethereumAddress = 'N/A (public key only)';
   }
   ```

---

## Testing Scenarios

### Test 1: Keystore Import + Method Toggle
```
1. Upload Chromium.json or Exodus.json
2. Enter password
3. Observe addresses generated
4. Toggle method to 'exodus'
5. ‚úÖ Should see message: "Keystore imports always use standard method"
6. ‚úÖ Addresses should remain the same (SR25519)
7. ‚úÖ No ETH address shown
8. ‚úÖ See note: "(Ethereum address requires raw private key)"
```

### Test 2: Raw Private Key + Method Toggle
```
1. Paste raw 64-char hex private key
2. Click "Use" with method = 'auto'
3. ‚úÖ Should route to ED25519
4. ‚úÖ Should show ETH address
5. Toggle method to 'polkadotjs'
6. ‚úÖ Should route to SR25519
7. ‚úÖ Addresses change (different derivation)
8. ‚úÖ Still shows ETH address
```

### Test 3: Console Logging
```
Expected console output for keystore import:
üè∑Ô∏è [ROUTER] Detected PKCS8_PUB marker
‚ö†Ô∏è [ROUTER] Keystore public keys always use SR25519, ignoring method selection
üîÑ [ROUTER] Keystore public key detected - routing to SR25519
üì¶ Using: DOT.Polkadot.sr25519
üìç [SR25519] Ethereum: N/A (public key only)
```

---

## Benefits

### For Users:
- ‚úÖ **Clear feedback** about why method toggle has no effect on keystores
- ‚úÖ **Understand why** ETH address isn't always available
- ‚úÖ **Consistent behavior** across all keystore imports
- ‚úÖ **Correct addresses** in all scenarios

### For Developers:
- ‚úÖ **Cleaner routing logic** with early detection
- ‚úÖ **Better separation** between keystore and raw key handling
- ‚úÖ **Easier debugging** with clear console logging
- ‚úÖ **Type-safe** with proper marker handling

### For Security:
- ‚úÖ **Enforced correctness** - keystore public keys always use correct module
- ‚úÖ **No address mistakes** from incorrect routing
- ‚úÖ **Clear limitations** - ETH derivation requires private key
- ‚úÖ **Audit trail** - console logs show routing decisions

---

## Files Modified

| File | Changes | Purpose |
|------|---------|---------|
| `router.DOT.Polkadot.ts` | Early keystore detection | Force SR25519 for keystores |
| `TemporaryKeyModal.tsx` | UI feedback message | Explain method toggle behavior |
| `multiFormatAddresses.tsx` | ETH availability note | Clarify when ETH shows |

---

## Related Documentation

- **Keystore Import Fix:** `docs/findings/20251006.polkadot.keystore.import.fix.md`
- **Test Fixtures:** `docs/findings/20251006.loginStandard.hardcodedAddresses.centralization.implementation.md`
- **Security Audit:** `docs/findings/20251006.loginStandard.hardcodedAddresses.security.audit.md`

---

## ‚úÖ Status: COMPLETE

Both issues have been resolved:
1. **Method toggle** now works correctly with proper enforcement and UI feedback
2. **ETH address display** now shows clear notes about availability

**No breaking changes** - all existing functionality preserved with improved UX.
