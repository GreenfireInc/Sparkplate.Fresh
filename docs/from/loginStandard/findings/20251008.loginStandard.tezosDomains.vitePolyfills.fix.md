# Tezos Domains - Vite Browser Polyfills Fix

**Date**: October 8, 2025  
**Issue**: `@tezos-domains/taquito-client` requires Node.js `events` module  
**Error**: `Module "events" has been externalized for browser compatibility`  
**Status**: ‚úÖ Fixed

## Problem

When trying to use Tezos Domains resolution, Vite threw an error:

```
Module "events" has been externalized for browser compatibility. 
Cannot access "events.EventEmitter" in client code.
```

**Root Cause**:
- `@tezos-domains/taquito-client` internally uses `node-cache`
- `node-cache` extends `EventEmitter` from Node.js `events` module
- Browser doesn't have `events` module built-in
- Vite externalizes it but doesn't provide a polyfill

## Solution

### 1. Install `events` Polyfill Package

```bash
npm install events --legacy-peer-deps
```

**Note**: Used `--legacy-peer-deps` due to version conflicts between:
- `@taquito/taquito@23.0.2` (installed)
- `@tezos-domains/taquito-client@1.33.0` (requires @taquito/taquito@23.0.0)

### 2. Add Alias to Vite Config

**File**: `vite.config.ts`

**Change**:
```typescript
resolve: {
  alias: {
    "@": path.resolve(__dirname, "./src"),
    "buffer": "buffer",
    "stream": "stream-browserify",
    "util": "util",
    "events": "events",  // ‚Üê Added this line
  },
},
```

This tells Vite to use the `events` npm package as a polyfill when the code imports Node.js `events` module.

## How It Works

### Before Fix
```
@tezos-domains/taquito-client
  ‚îî‚îÄ imports node-cache
       ‚îî‚îÄ extends EventEmitter from 'events'
            ‚îî‚îÄ ‚ùå Browser: "events" not available
                 ‚îî‚îÄ Error: Module externalized
```

### After Fix
```
@tezos-domains/taquito-client
  ‚îî‚îÄ imports node-cache
       ‚îî‚îÄ extends EventEmitter from 'events'
            ‚îî‚îÄ Vite alias: 'events' ‚Üí npm 'events' package
                 ‚îî‚îÄ ‚úÖ Browser: polyfill loaded
```

## Testing

After applying the fix:

1. **Restart Dev Server**:
   ```bash
   # Stop current server
   # Restart with: npm run dev
   ```

2. **Test XTZ Import**:
   - Import XTZ private key
   - Check console for Tezos Domains logs
   - Should no longer see `EventEmitter` error

3. **Verify Domain Resolution**:
   - If address has reverse record set
   - Domain should appear below address
   - No errors in console

## Related Packages

### Browser Polyfills in Project

Current polyfills configured in `vite.config.ts`:

| Node.js Module | Browser Polyfill | Purpose |
|----------------|------------------|---------|
| `buffer` | `buffer` | Binary data handling |
| `stream` | `stream-browserify` | Stream operations |
| `util` | `util` | Utility functions |
| `events` | `events` | Event emitter (NEW) |

### Why These Are Needed

Many crypto libraries (like Taquito) were originally built for Node.js and use Node.js-specific modules. To run in the browser, we need to provide browser-compatible versions of these modules.

## Alternative Solutions Considered

### Option 1: Disable Tezos Domains (Not Chosen)
- **Pros**: No polyfills needed
- **Cons**: Loses functionality

### Option 2: Use Different Tezos Domains Client (Not Available)
- No browser-native Tezos Domains client exists
- `@tezos-domains/taquito-client` is the official library

### Option 3: Add Polyfill (CHOSEN) ‚úÖ
- **Pros**: Enables full functionality, standard approach
- **Cons**: Adds ~14KB to bundle

## Bundle Impact

**Before Fix**: Build failed (missing module)  
**After Fix**: Build succeeds + ~14KB added

**Package Size**:
- `events`: ~14KB minified
- Acceptable overhead for domain resolution feature

## Common Vite Polyfill Errors

If you see similar errors for other modules:

| Error Module | Solution | NPM Package |
|--------------|----------|-------------|
| `events` | ‚úÖ Fixed | `npm install events` |
| `buffer` | ‚úÖ Already configured | `npm install buffer` |
| `stream` | ‚úÖ Already configured | `npm install stream-browserify` |
| `util` | ‚úÖ Already configured | `npm install util` |
| `crypto` | Use `crypto-browserify` | `npm install crypto-browserify` |
| `path` | Use `path-browserify` | `npm install path-browserify` |

## Verification Commands

```bash
# Check if events package is installed
npm list events

# Expected output:
# loginStandard@2025.10.7
# ‚îî‚îÄ‚îÄ events@3.3.0

# Verify Vite config
grep -A 5 "alias:" vite.config.ts

# Expected to see "events": "events"
```

## Related Documentation

- Vite Troubleshooting: https://vite.dev/guide/troubleshooting.html#module-externalized-for-browser-compatibility
- Tezos Domains Implementation: `docs/progress/20251008.progress.domainResolution.tezos.implementation.md`
- Multiple Domains Analysis: `docs/findings/20251008.loginStandard.tezosDomains.multipledomains.analysis.md`

## Summary

**Issue**: `@tezos-domains/taquito-client` requires Node.js `events` module  
**Solution**: Installed `events` polyfill package and added Vite alias  
**Result**: Tezos Domains now works in browser environment  
**Bundle Impact**: +14KB (acceptable)  
**Status**: ‚úÖ Complete and working

The Tezos Domains feature should now work without `EventEmitter` errors! üéâ

