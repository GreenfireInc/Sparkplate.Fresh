# libsodium-wrappers-sumo ESM Import Resolution Failure

**Date:** January 17, 2026  
**Component:** Vite Build Configuration  
**Affected Project:** Sparkplate.fresh.Grey  
**Working Project:** Sparkplate.fresh

---

## Problem Description

When running `npm run dev` in `Sparkplate.fresh.Grey`, the build fails with the following error:

```
✘ [ERROR] Could not resolve "./libsodium-sumo.mjs"

    node_modules/libsodium-wrappers-sumo/dist/modules-sumo-esm/libsodium-wrappers.mjs:1:13:

      1 │ import e from"./libsodium-sumo.mjs";let a;const r={},t=e.ready.then...
                       ~~~~~~~~~~~~~~~~~~~~~~

Error: Build failed with 1 error:
node_modules/libsodium-wrappers-sumo/dist/modules-sumo-esm/libsodium-wrappers.mjs:1:13: 
ERROR: Could not resolve "./libsodium-sumo.mjs"
```

However, `Sparkplate.fresh` (without the `.Grey` suffix) runs without any errors using the same `libsodium-wrappers-sumo` dependency.

---

## Root Cause Analysis

### The Difference: Package Version

| Project | libsodium-wrappers-sumo Version | Has `module` Field |
|---------|--------------------------------|-------------------|
| Sparkplate.fresh | **0.7.15** | ❌ No |
| Sparkplate.fresh.Grey | **0.7.16** | ✅ Yes |

### Why Version 0.7.16 Fails

In version **0.7.16**, the `libsodium-wrappers-sumo` package added a new `module` field to its `package.json`:

**Version 0.7.15** (`Sparkplate.fresh`):
```json
{
  "version": "0.7.15",
  "main": "dist/modules-sumo/libsodium-wrappers.js"
}
```

**Version 0.7.16** (`Sparkplate.fresh.Grey`):
```json
{
  "version": "0.7.16",
  "main": "dist/modules-sumo/libsodium-wrappers.js",
  "module": "dist/modules-sumo-esm/libsodium-wrappers.mjs"
}
```

### Module Resolution Behavior

When Vite/esbuild bundles a package:

1. **With `module` field present**: Bundlers prefer the ESM entry (`modules-sumo-esm/libsodium-wrappers.mjs`)
2. **Without `module` field**: Bundlers use the CommonJS entry (`modules-sumo/libsodium-wrappers.js`)

### The ESM Entry's Broken Import

The ESM entry file (`libsodium-wrappers.mjs`) contains a **relative import**:

```javascript
import e from "./libsodium-sumo.mjs";
```

This import expects `libsodium-sumo.mjs` to be in the **same directory**. However:

- The `libsodium-sumo.mjs` file exists in a **separate npm package** (`libsodium-sumo`)
- It's located at: `node_modules/libsodium-sumo/dist/modules-sumo-esm/libsodium-sumo.mjs`
- **NOT** at: `node_modules/libsodium-wrappers-sumo/dist/modules-sumo-esm/libsodium-sumo.mjs`

This is a **packaging bug** in `libsodium-wrappers-sumo@0.7.16` where the ESM build incorrectly assumes the dependency file is local.

### Why CommonJS Works

The CommonJS version (`libsodium-wrappers.js`) uses `require()`:

```javascript
var e = require("libsodium-sumo");
```

Node.js and bundlers can properly resolve `require("libsodium-sumo")` to the correct package in `node_modules/`, whereas the relative ESM import `./libsodium-sumo.mjs` cannot be resolved.

---

## Environment Comparison

| Aspect | Sparkplate.fresh | Sparkplate.fresh.Grey |
|--------|------------------|----------------------|
| libsodium-wrappers-sumo | 0.7.15 | 0.7.16 |
| Vite version | 6.4.1 | 6.3.5 |
| Entry point used | CommonJS (main) | ESM (module) |
| Build result | ✅ Success | ❌ Failure |

---

## Solution

### Option 1: Alias to CommonJS Version (Recommended)

Force Vite to use the CommonJS version instead of the ESM version:

```typescript
// vite.config.ts
resolve: {
  alias: {
    // Force use of CommonJS version to avoid ESM relative import issue
    'libsodium-wrappers-sumo': path.resolve(
      __dirname, 
      'node_modules/libsodium-wrappers-sumo/dist/modules-sumo/libsodium-wrappers.js'
    ),
  },
},
```

### Option 2: Exclude from optimizeDeps

Prevent esbuild from pre-bundling the package:

```typescript
// vite.config.ts
optimizeDeps: {
  exclude: [
    'libsodium-wrappers-sumo',
    'libsodium-sumo',
  ],
},
```

### Option 3: Pin to Version 0.7.15

Downgrade to the version without the problematic `module` field:

```json
// package.json
{
  "dependencies": {
    "libsodium-wrappers-sumo": "0.7.15"
  }
}
```

### Option 4: Custom Resolver Plugin

Create a Vite plugin to fix the relative import:

```typescript
function libsodiumResolver() {
  return {
    name: 'libsodium-resolver',
    enforce: 'pre' as const,
    resolveId(source: string, importer?: string) {
      if (source === './libsodium-sumo.mjs' && 
          importer?.includes('libsodium-wrappers-sumo')) {
        return require.resolve(
          'libsodium-sumo/dist/modules-sumo-esm/libsodium-sumo.mjs'
        )
      }
      return null
    }
  }
}
```

---

## Applied Fix

The fix applied to `Sparkplate.fresh.Grey` combines **Option 1** and **Option 2**:

```typescript
// vite.config.ts

resolve: {
  alias: {
    // Fix libsodium-wrappers-sumo ESM import issue - use CJS version instead
    'libsodium-wrappers-sumo': path.resolve(
      __dirname, 
      'node_modules/libsodium-wrappers-sumo/dist/modules-sumo/libsodium-wrappers.js'
    ),
  },
},

optimizeDeps: {
  exclude: [
    // Exclude libsodium packages - their ESM exports have relative imports that break esbuild
    'libsodium-wrappers-sumo',
    'libsodium-sumo',
  ],
},
```

---

## Key Takeaways

1. **Minor version bumps can break builds**: The change from 0.7.15 to 0.7.16 introduced a `module` field that changed which entry point bundlers use.

2. **ESM packaging issues are common**: Many npm packages have broken ESM exports due to incorrect relative imports or missing files.

3. **`module` field priority**: When present, bundlers prefer the `module` entry over `main`, which can expose previously hidden issues.

4. **Lockfile differences matter**: `Sparkplate.fresh` had an older lockfile with 0.7.15, while `Sparkplate.fresh.Grey` resolved to the newer 0.7.16.

5. **CommonJS is more reliable**: For packages with ESM issues, aliasing to the CommonJS version is often the safest workaround.

---

## References

- [Vite resolve.alias documentation](https://vitejs.dev/config/shared-options.html#resolve-alias)
- [ESBuild resolution algorithm](https://esbuild.github.io/api/#resolve)
- [Node.js conditional exports](https://nodejs.org/api/packages.html#conditional-exports)
- [libsodium-wrappers-sumo npm package](https://www.npmjs.com/package/libsodium-wrappers-sumo)

---

## Affected Files

- `Sparkplate.fresh.Grey/vite.config.ts` - Added alias and exclude configuration
- `Sparkplate.fresh.Grey/package-lock.json` - Contains newer package versions

---

## Timeline

| Time | Event |
|------|-------|
| Package install | `libsodium-wrappers-sumo@0.7.16` installed (has `module` field) |
| Build start | Vite/esbuild selects ESM entry due to `module` field |
| Resolution | esbuild tries to resolve `./libsodium-sumo.mjs` relative import |
| Failure | File not found - it's in a different package directory |
| Fix applied | Alias forces CommonJS entry, excludes from pre-bundling |
| Build success | CommonJS `require()` resolves correctly |

