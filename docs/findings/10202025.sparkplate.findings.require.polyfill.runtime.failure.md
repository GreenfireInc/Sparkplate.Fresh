# Require Polyfill Runtime Failure - Persistent Browser Context Error

**Date:** October 20, 2025  
**Branch:** CS.Fixes.About.General.Pass.2Two  
**Category:** Build System / Runtime Polyfills  
**Status:** üö® Critical - Polyfills Not Working at Runtime

## Overview

Despite installing all dependencies and configuring Vite polyfills, the `require is not defined` error persists at runtime. The polyfills are being configured but **not actually injected into the production bundle**, causing the same error in the AppImage.

---

## Error Details

### **Persistent Error:**
```
index-WUjwwN_2.js:222 Uncaught ReferenceError: require is not defined
    at index-WUjwwN_2.js:222:41130
    at requireSafeBuffer (index-WUjwwN_2.js:222:41940)
    at requireSrc$6 (index-WUjwwN_2.js:222:42101)
    at requireBs58 (index-WUjwwN_2.js:224:7379)
    at index-WUjwwN_2.js:224:7495
```

### **What We've Tried:**

1. ‚úÖ Installed `tweetnacl`
2. ‚úÖ Configured `vite-plugin-node-polyfills`
3. ‚úÖ Added module aliases
4. ‚úÖ Configured optimizeDeps
5. ‚ùå **Still fails at runtime**

---

## Root Cause: Polyfills Not Injecting

### **The Real Problem:**

The `vite-plugin-node-polyfills` plugin **only works for dev server**, not production builds. The polyfills are:
- ‚úÖ Available during development
- ‚ùå **NOT included in production bundle**

### **Why This Happens:**

1. **Vite's Rollup backend** doesn't automatically include polyfills
2. **Plugin limitations** - Some polyfill plugins only work in dev mode
3. **Tree shaking** - Vite removes "unused" polyfills
4. **Bundle optimization** - Aggressive minification breaks polyfill injection

### **Evidence:**

The error trace shows:
- `requireSafeBuffer` - Trying to `require('safe-buffer')`
- `requireBs58` - Trying to `require('bs58')`
- These are **wrapped in require() calls** that aren't being polyfilled

---

## Technical Analysis

### **Current Polyfill Strategy (Not Working):**

```typescript
// vite.config.ts - Current approach
nodePolyfills({
  protocolImports: true,
  globals: { Buffer: true, global: true, process: true },
  include: ['buffer', 'process', 'util', 'stream', ...],
})
```

**Problem:** This only polyfills **ES module imports**, not **CommonJS require()**

### **What We Need:**

We need to polyfill the **`require()` function itself**, not just the modules.

---

## Solution: Multiple Strategies

### **Strategy 1: Lazy Load Domain Features (RECOMMENDED)**

**Concept:** Don't load blockchain libraries until user needs them

**Benefits:**
- ‚úÖ App loads immediately without blockchain deps
- ‚úÖ Smaller initial bundle
- ‚úÖ Issues isolated to feature usage
- ‚úÖ Better user experience

**Implementation:**

```typescript
// src/utils/currencyCore/domains/index.ts
export async function loadDomainServices() {
  // Only import when needed
  const modules = await import('./domains-impl')
  return modules
}

// src/components/pages/cryptocurrency/DomainResolver.vue
async function resolveDomain(domain: string) {
  try {
    const { domains } = await import('@/utils/currencyCore/domains/index')
    return await domains.resolveAddress({ domain, coinTicker })
  } catch (error) {
    console.error('Failed to load domain services:', error)
    showError('Domain resolution unavailable')
  }
}
```

### **Strategy 2: Add Define Plugin (Quick Fix)**

**Concept:** Define `require` as a global function in the bundle

**Implementation:**

```typescript
// vite.config.ts
define: {
  global: 'globalThis',
  'process.env': '{}',
  'typeof require': '"undefined"', // Tell code require doesn't exist
}
```

**Or better:**

```typescript
define: {
  global: 'globalThis',
  require: '((id) => { throw new Error("require not available: " + id) })'
}
```

### **Strategy 3: Rollup Plugin for CommonJS**

**Concept:** Use Rollup plugin to convert require() to imports

```bash
npm install --save-dev @rollup/plugin-commonjs
```

```typescript
// vite.config.ts
import commonjs from '@rollup/plugin-commonjs'

export default defineConfig({
  build: {
    rollupOptions: {
      plugins: [
        commonjs({
          include: /node_modules/,
          requireReturnsDefault: 'auto',
        })
      ]
    }
  }
})
```

### **Strategy 4: External Dependencies**

**Concept:** Mark problematic deps as external, load from CDN

```typescript
build: {
  rollupOptions: {
    external: [
      'tweetnacl',
      'bs58',
      '@solana/web3.js',
      '@bonfida/spl-name-service'
    ]
  }
}
```

Then load from CDN:
```html
<script src="https://cdn.jsdelivr.net/npm/tweetnacl@1.0.3/nacl-fast.min.js"></script>
```

---

## Recommended Fix: Hybrid Approach

### **Phase 1: Immediate - Make Domain Resolution Optional**

**Goal:** App loads even if domains don't work

```typescript
// src/components/pages/cryptocurrency/DomainResolver.vue
const isDomainResolutionAvailable = ref(false)

onMounted(async () => {
  try {
    // Test if domain resolution works
    await import('@/utils/currencyCore/domains/index')
    isDomainResolutionAvailable.value = true
  } catch (error) {
    console.warn('Domain resolution unavailable:', error)
    isDomainResolutionAvailable.value = false
  }
})
```

### **Phase 2: Fix Polyfills Properly**

**Add Rollup CommonJS plugin:**

```bash
npm install --save-dev @rollup/plugin-commonjs @rollup/plugin-node-resolve
```

**Update vite.config.ts:**

```typescript
import commonjs from '@rollup/plugin-commonjs'
import nodeResolve from '@rollup/plugin-node-resolve'

export default defineConfig({
  build: {
    commonjsOptions: {
      include: [/node_modules/],
      transformMixedEsModules: true,
    },
    rollupOptions: {
      plugins: [
        nodeResolve({
          browser: true,
          preferBuiltins: false,
        }),
        commonjs({
          include: /node_modules/,
          requireReturnsDefault: 'auto',
        })
      ]
    }
  }
})
```

### **Phase 3: Test Thoroughly**

```bash
npm run build
./dist_electron/2025.10.19/Sparkplate.2025.10.19.AppImage
```

---

## Alternative: Remove Problematic Domain Services

If domain resolution continues to be problematic:

### **Option A: Disable Temporarily**

Comment out Solana/Algorand domains:
```typescript
// src/utils/currencyCore/domains/index.ts
export const domains = {
  ens,
  uns,
  tezos,
  // sol,     // Disabled - causes build issues
  // algo,    // Disabled - causes build issues
  // stx,     // Disabled - causes build issues
}
```

### **Option B: Implement Server-Side**

Move domain resolution to backend:
- Electron main process can use Node.js
- Use IPC to communicate with renderer
- No browser polyfill issues

```typescript
// background/main/index.ts
ipcMain.handle('resolveDomain', async (_, { domain, coinTicker }) => {
  // Use native Node.js here - no polyfill needed
  const { domains } = require('./domains')
  return await domains.resolveAddress({ domain, coinTicker })
})
```

---

## Why Dev Works But Production Fails

### **Development Mode:**
- Vite dev server uses esbuild
- Node polyfills work automatically
- Hot module replacement hides issues
- No minification/tree-shaking

### **Production Mode:**
- Uses Rollup for final bundle
- Aggressive optimization
- Tree shaking removes polyfills
- Minification changes code structure
- CommonJS ‚Üí ESM conversion incomplete

---

## Implementation Steps

### **Step 1: Install Additional Plugins**

```bash
npm install --save-dev @rollup/plugin-commonjs @rollup/plugin-node-resolve
```

### **Step 2: Update vite.config.ts**

Add the complete configuration with CommonJS support

### **Step 3: Add Fallback Handling**

Make domain resolution optional in UI

### **Step 4: Rebuild and Test**

```bash
npm run build
./dist_electron/2025.10.19/Sparkplate.2025.10.19.AppImage
```

### **Step 5: If Still Fails**

Consider lazy loading or moving to backend

---

## Expected Outcomes

### **After Fix:**

**Best Case:**
- ‚úÖ All domain services work
- ‚úÖ No require errors
- ‚úÖ Full functionality

**Acceptable:**
- ‚úÖ App loads and works
- ‚ö†Ô∏è Domain resolution gracefully disabled
- ‚ÑπÔ∏è User sees message: "Domain resolution unavailable"

**Worst Case:**
- Move domain resolution to backend
- IPC-based architecture
- More complex but more reliable

---

## Lessons Learned

### **1. Test Production Builds Early**

Don't rely on dev server:
```bash
npm run build  # Test often!
```

### **2. Avoid Node.js Libraries in Frontend**

When possible:
- Use browser-native APIs
- Find browser-compatible alternatives
- Move to backend if necessary

### **3. Polyfills Are Tricky**

- Polyfills work differently in dev vs prod
- Not all polyfill plugins support production
- CommonJS requires special handling

### **4. Progressive Enhancement**

Features should degrade gracefully:
- Core app works without blockchain
- Domain resolution is enhancement
- User gets feedback if unavailable

---

**Priority:** üö® **CRITICAL**  
**Blocking:** Application functionality  
**Estimated Fix Time:** 1-2 hours  
**Complexity:** High (requires architectural changes)

---

**Contributors:** Corey  
**Status:** üîÑ **In Progress - Implementing Fix**

---

## Resolution Steps Taken

### **Step 1: Installed Rollup Plugins**

```bash
npm install --save-dev @rollup/plugin-commonjs @rollup/plugin-node-resolve
```

Installed:
- `@rollup/plugin-commonjs` - Converts CommonJS modules to ES modules
- `@rollup/plugin-node-resolve` - Resolves node_modules with browser field support

### **Step 2: Updated vite.config.ts**

Added imports:
```typescript
import commonjs from '@rollup/plugin-commonjs'
import nodeResolve from '@rollup/plugin-node-resolve'
```

Enhanced build configuration:
```typescript
build: {
  commonjsOptions: {
    include: [/node_modules/],
    transformMixedEsModules: true,
  },
  rollupOptions: {
    plugins: [
      nodeResolve({
        browser: true,
        preferBuiltins: false,
        extensions: ['.js', '.json', '.mjs'],
      }),
      commonjs({
        include: /node_modules/,
        requireReturnsDefault: 'auto',
        transformMixedEsModules: true,
      })
    ],
  },
}
```

**What this does:**
- **nodeResolve:** Resolves npm packages with browser-compatible versions
- **commonjs:** Converts `require()` calls to ES module `import` statements
- **transformMixedEsModules:** Handles packages that mix CommonJS and ES modules
- **preferBuiltins: false:** Use browser polyfills instead of Node built-ins

### **Step 3: Building**

Running `npm run build` to test if the fix works...

**Expected outcome:**
- ‚úÖ All `require()` calls converted to `import`
- ‚úÖ No runtime `require is not defined` errors
- ‚úÖ Domain resolution features work
- ‚úÖ AppImage runs successfully

**If this still fails:**
- Consider lazy loading (Strategy 1 from above)
- Move domain resolution to Electron main process
- Disable problematic blockchain integrations temporarily

**Testing:** October 20, 2025 - In Progress
