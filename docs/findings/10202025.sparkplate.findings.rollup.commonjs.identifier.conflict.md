# Rollup CommonJS Identifier Conflict - Blocking Production Build

**Date:** October 20, 2025  
**Branch:** CS.Fixes.About.General.Pass.2Two  
**Category:** Build System / Rollup / CommonJS Conversion  
**Status:** üö® Critical - Build Cannot Complete

## Overview

Build fails with Rollup CommonJS plugin throwing identifier conflicts. The error `Identifier "require$$0" has already been declared` indicates that multiple CommonJS modules are being transformed with conflicting variable names, specifically in blockchain dependency chains.

---

## Error Details

### **Error Message:**
```
[commonjs] node_modules/readable-stream/lib/_stream_writable.js (7:22): 
Identifier "require$$0" has already been declared
```

### **Affected Package:**
`@unstoppabledomains/resolution` ‚Üí `readable-stream` ‚Üí Variable name collision

### **Build Stack:**
1. Vite transforms 2208+ modules
2. Rollup CommonJS plugin processes node_modules
3. Multiple requires create duplicate variable names
4. Build fails with identifier already declared

---

## Root Cause Analysis

### **The Fundamental Problem:**

Blockchain libraries have **deeply nested CommonJS dependencies** that are incompatible with browser bundling:

```
Sparkplate (Browser)
  ‚îî‚îÄ @unstoppabledomains/resolution
       ‚îî‚îÄ readable-stream (CommonJS)
            ‚îî‚îÄ util (Node.js built-in)
                 ‚îî‚îÄ Multiple conflicting requires
```

### **Why This Happens:**

1. **CommonJS to ESM conversion** creates helper variables like `require$$0`, `require$$1`
2. **Deep dependency trees** with circular dependencies
3. **Multiple copies of same package** at different versions
4. **Rollup can't deduplicate** the generated variable names
5. **Identifier collision** when merging transformed modules

### **Specific Culprits:**

- `readable-stream` - Used by crypto libraries
- `@unstoppabledomains/resolution` - Uses many Node.js streams
- `@solana/web3.js` - Heavy Node.js dependencies
- `@taquito/taquito` - Tezos blockchain libraries
- `@bonfida/spl-name-service` - Solana name service

---

## Why Blockchain Libraries Are Problematic

### **1. Designed for Node.js:**
- Use Node.js `crypto`, `stream`, `buffer`
- Expect CommonJS module system
- Not optimized for browsers

### **2. Heavy Dependencies:**
- Cryptographic operations
- Binary data manipulation
- Network protocols
- Stream processing

### **3. Circular Dependencies:**
- Many packages depend on each other
- Creates duplicate instances
- Rollup can't resolve conflicts

---

## Failed Attempts Summary

### **Attempt 1: Basic Polyfills**
- Added `vite-plugin-node-polyfills`
- **Result:** Build succeeded, runtime failed with "require is not defined"

### **Attempt 2: Install Missing Dependencies**
- `npm install tweetnacl stream-browserify buffer`
- **Result:** Build succeeded, same runtime error

### **Attempt 3: Rollup CommonJS Plugin**
- Added `@rollup/plugin-commonjs` and `@rollup/plugin-node-resolve`
- **Result:** Build fails with identifier conflicts (current error)

---

## Solution: Pragmatic Approach

Given the time spent and complexity of blockchain bundling, the pragmatic solution is:

### **Disable Problematic Domain Services Temporarily**

Keep ENS (which works), disable others that cause build issues:

```typescript
// src/utils/currencyCore/domains/index.ts
import ens from './ens'
// Temporarily disabled due to browser bundling issues:
// import uns from './uns'
// import { tezosUtils as tezos } from './tezosDomains'  
// import sol from './sol'
// import algo from './algo'
// import stx from './stx'

export const domains = {
  ens,
  // uns,    // Disabled - @unstoppabledomains/resolution causes build issues
  // tezos,  // Disabled - @taquito has deep Node.js dependencies
  // sol,    // Disabled - @solana/web3.js not browser-compatible
  // algo,   // Disabled - Complex dependency chain
  // stx,    // Disabled - BNS has Node.js requirements
}
```

### **Benefits:**

1. ‚úÖ **Build succeeds** immediately
2. ‚úÖ **App works** with partial domain resolution
3. ‚úÖ **ENS still functional** (most popular service)
4. ‚úÖ **Can iterate** on solutions without blocking progress
5. ‚úÖ **User experience** preserved for core features

---

## Alternative Solutions (Future Work)

### **Option 1: Backend Domain Resolution**

Move blockchain calls to Electron main process:

```typescript
// background/main/index.ts
ipcMain.handle('resolveDomain', async (_, { domain, coinTicker }) => {
  // Native Node.js environment - no browser issues
  const { domains } = require('./domains')
  return await domains.resolveAddress({ domain, coinTicker })
})

// src/components/DomainResolver.vue
async function resolveDomain(domain, coinTicker) {
  return await window.ipcRenderer.invoke('resolveDomain', { domain, coinTicker })
}
```

**Benefits:**
- ‚úÖ No browser compatibility issues
- ‚úÖ Full Node.js environment available
- ‚úÖ Can use any npm package
- ‚úÖ Better security (API keys in main process)

### **Option 2: API Proxy Service**

Create backend service for domain resolution:

```typescript
// External service or Electron backend
app.post('/api/resolve-domain', async (req, res) => {
  const { domain, coinTicker } = req.body
  const address = await resolveDomain(domain, coinTicker)
  res.json({ address })
})
```

### **Option 3: Browser-Native Implementations**

Rewrite resolvers using only browser APIs:
- Use `fetch()` for API calls
- Use Web Crypto API instead of Node crypto
- Avoid stream processing

---

## Implementation Plan

### **Phase 1: Immediate (Today)**

1. Comment out problematic domain imports
2. Keep ENS functional
3. Add UI message about limited domain support
4. Complete build successfully
5. Test AppImage

### **Phase 2: Short-term (This Week)**

1. Implement backend domain resolution
2. Move domain logic to Electron main process
3. Use IPC for communication
4. Re-enable all domain services

### **Phase 3: Long-term (Future)**

1. Consider API proxy service
2. Evaluate browser-native implementations
3. Monitor for updated packages with better browser support

---

## Files to Modify

### **1. Disable Problematic Imports:**
```typescript
// src/utils/currencyCore/domains/index.ts
- Comment out UNS, Solana, Tezos, Algorand, Stacks imports
- Keep ENS only
```

### **2. Update UI to Show Limited Support:**
```vue
// src/components/pages/cryptocurrency/DomainResolver.vue
<div v-if="!isServiceAvailable" class="alert">
  Currently supporting ENS (.eth) domains only.
  Additional services coming soon!
</div>
```

### **3. Restore Vite Config:**
```typescript
// vite.config.ts  
- Remove Rollup CommonJS plugin
- Keep basic polyfills
```

---

## Lessons Learned

### **1. Not All npm Packages Are Browser-Compatible**

Just because a package exists doesn't mean it works in browsers:
- Check "browser" field in package.json
- Look for browser-specific builds
- Test production builds early

### **2. Blockchain Libraries Are Complex**

Cryptocurrency libraries often:
- Use heavy cryptography
- Expect Node.js environment
- Have deep dependency trees
- Not optimized for bundling

### **3. Progressive Enhancement**

Features should be:
- Optional, not required
- Gracefully degradable
- Clearly communicate limitations
- Have fallback options

### **4. Consider Architecture Early**

For Node.js-heavy features:
- Use Electron main process
- Create backend services
- Don't force browser compatibility

---

## Expected Outcome

### **After Disabling Problematic Services:**

‚úÖ Build completes successfully  
‚úÖ AppImage creates without errors  
‚úÖ App runs and loads  
‚úÖ ENS domain resolution works  
‚ö†Ô∏è Other domain services temporarily unavailable  
‚ÑπÔ∏è User sees clear message about limitations  

### **Timeline:**

- **Immediate:** Disable services, build succeeds
- **This week:** Implement backend resolution
- **Next sprint:** Full domain support restored

---

**Priority:** üö® **CRITICAL - BLOCKING**  
**Estimated Fix Time:** 30 minutes (disable services)  
**Long-term Solution:** 4-8 hours (backend implementation)  
**Complexity:** High (architectural change needed)

---

**Contributors:** Corey  
**Status:** üîÑ **Implementing Pragmatic Fix**

---

## Resolution

Implementing immediate fix: disabling problematic blockchain domain services to unblock build process.

**Date:** October 20, 2025  
**Decision:** Pragmatic approach - partial functionality now, full solution later
