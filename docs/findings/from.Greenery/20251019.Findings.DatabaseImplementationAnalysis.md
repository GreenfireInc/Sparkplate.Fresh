# Database Implementation Analysis

## Overview

The Greenery application uses IndexedDB (browser-based database) through a JavaScript library called JSStore (version 4.5.2). The database implementation provides a structured storage solution for the cryptocurrency wallet and its accounting functions.

## Database Configuration

- **Database Name**: Greenery
- **Current Version**: 12
- **Main Configuration File**: `src/service/IdbService.js`

## Core Database Structure

### Database Service Files

- **`src/service/IdbService.js`**: Main database configuration and initialization
  - Handles database version management
  - Manages database migrations
  - Initializes database connection
  - Configures middleware for encryption/decryption

### Table Definitions

All table schemas are defined in `src/service/tables/` with the following structure:

1. `users.js` - User account information
2. `transactions.js` - Transaction records
3. `invoices.js` - Invoice data
4. `contacts.js` - Contact information
5. `contactAddresses.js` - Addresses associated with contacts
6. `exchangeContacts.js` - Exchange-specific contacts
7. `activityHistory.js` - User activity records
8. `wallets.js` - Wallet information
9. `paperWallets.js` - Paper wallet data
10. `history.js` - Historical data
11. `userSettings.js` - User preferences and settings
12. `paperWalletImportHistory.js` - Paper wallet import records
13. `errors.js` - Error logs
14. `web3Connections.js` - Web3 connection data
15. `mnemonicPasswords.js` - Encrypted mnemonic passwords
16. `quickExchangeHistory.js` - Quick exchange transaction history

### Encryption Implementation

The application implements encryption for sensitive data using CryptoJS.AES through a middleware called `cypherMiddleware`. The encryption logic is defined in `src/service/middleware/cypherMiddleware.js` and `src/service/Cypher.js`.

Encrypted fields include:
- **wallets**: wif, privateKey
- **users**: googleAuthenticatorCode, mnemonic
- **paperWallets**: privateKey
- **userSettings**: emailConfigPassword, exchanges (with nested encryption for apiKey, apiSecret, apiPhrase)
- **mnemonicPasswords**: mpPrivateKey

## Database Versioning and Migration

The database uses a versioning system currently at version 12. Migration logic is implemented in `IdbService.js` through the `performDatabaseUpdate` function, which incrementally updates the database when a new version is detected.

Migration examples:
- Version 3: Convert all user emails to lowercase
- Version 6: Set all existing contacts type to 'regular'
- Version 8 & 9: Clear transaction table to update with network data and ETH tokens
- Version 10: Add default mfaOnWeb3Requests to existing accounts

## File Storage Integration

In addition to the IndexedDB database, the application also uses a file-based storage system implemented in `src/utils/general/fileStorage.js`. This provides persistent JSON storage for various configuration items:

- Email configuration
- Journal history
- Error logs
- Notification storage
- Invoice filing

## Data Flow

The database is accessed through various service classes that abstract the database operations:
- `UserService.js`
- `ContactService.js`
- `TransactionService.js`
- `SettingsService.js`
- `ErrorService.js`
- `PaperWalletService.js`

These services handle CRUD operations and business logic related to their respective domains.

## Security Considerations

- Sensitive data is encrypted before storage using CryptoJS.AES
- The encryption middleware can be bypassed for specific operations using the `bypassCypherMiddleware: true` flag
- Multiple layers of data protection are implemented (IndexedDB security + custom encryption)
- Encrypted fields are decrypted only when needed and returned to their original state in the UI

## Vuex Integration

The state management system (Vuex) interacts with the database through modules that correspond to the database tables:
- `accountsModule`
- `activityModule`
- `contactModule`
- `walletModule`
- etc.

Additional persistence is provided through `vuex-persistedstate` with secure local storage using the `secure-ls` library.
