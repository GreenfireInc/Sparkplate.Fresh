# Progress Report: TemporaryKeyModal UX + Key Derivation + Vite Crypto/WASM Fixes
**Date:** Tuesday Dec 23 2025  
**Project:** Sparkplate.fresh  
**Area:** Authentication / Temporary Key Import + Build System (Vite)  

## Summary
Improved the Temporary Key import flow UI/UX (networks dropdown, file import, inline “Use” action, visible key, QR code rendering) and stabilized the Vite build pipeline for crypto-heavy dependencies (WASM/CSP + noble/polkadot resolution). Added a Vue QR-code implementation matching the legacy loginStandard reference and iterated on Solana Ed25519 SHA-512 support (ongoing).

## Key Deliverables Completed

### 1) TemporaryKeyModal (Vue) UI/UX parity with loginStandard reference
- **Custom network dropdown w/ icons**
  - Replaced native `<select>` so icons can render per-network.
  - Teleported dropdown menu to `<body>` to avoid modal clipping.
  - Added outside-click handling and dynamic `getBoundingClientRect()` positioning.
- **Private key input layout improvements**
  - Added right padding to accommodate the upload icon.
  - Adjusted sizing/spacing so the input and “Use” button don’t touch modal edges.
  - Moved “Use” button inline at end of the input row (reference parity).
  - Removed the Cancel button while preserving spacing.
- **File import enabled**
  - Added hidden file input (`.json,.txt,.key,.csv`) and wired the upload button to populate the private key field.
  - Added keystore JSON detection to prevent pasting encrypted keystore objects as raw keys.
- **Private key visibility**
  - Updated to show plaintext (no asterisks) per user request.

### 2) QR Code enabled in TemporaryKeyModal
- Installed **`qrcode.vue@3`** and rendered a QR code after derivation.
- QR code value is the derived address; styling matches the reference:
  - White background, black foreground, 280px size, error correction “H”.
  - Overlayed the selected network icon in the center.
- Added spacing adjustments between input section and QR section (iterated).

### 3) About modal export enhancements (completed earlier in this thread)
- Added static, smaller, transparent footer.
- Moved “Clear Store” button into footer.
- Added “Export sysInfo” dropdown (PNG/PDF/JSON/TXT) with formatted filenames.
- Fixed export background for PNG/PDF to be white.
- Added logo overlay to PNG/PDF exports.

## Build / Runtime Fixes Completed

### 1) CSP: WebAssembly blocked
- Updated `index.html` CSP to allow WASM compilation by adding `script-src` directive support (`'wasm-unsafe-eval'`), resolving:
  - `WebAssembly.instantiateStreaming(): Refused to compile ... 'unsafe-eval' not allowed ...`

### 2) Vite dep-prebundle / module export mismatches (crypto libs)
- Reduced over-aggressive `optimizeDeps.exclude` (previously blocking correct pre-bundling).
- Added a scoped resolver strategy for **@noble** subpaths:
  - Avoid rewriting imports from `node_modules` (prevents breaking deps that ship their own nested noble versions).
  - Only assist project-source imports that omit required `.js` subpath conventions.
- Improved handling for Polkadot/wasm module resolution issues (iterative stabilization).

## Solana Derivation: Current Status
- **Problem:** `Failed to derive Solana address: hashes.sha512 not set`
- **Root cause:** `@noble/ed25519` requires explicit SHA-512 wiring before sync derivation.
- **Work done:** Investigated expected hook per installed `@noble/ed25519` implementation and applied startup configuration attempts.
- **Status:** Still being validated end-to-end in the app; further adjustments may be needed to ensure the correct noble “sha512” wiring occurs before SOL derivation.

## Files Touched (high-signal)
- `src/components/modals/loginOptions/TemporaryKeyModal.vue`
- `src/components/modals/about/Main.vue`
- `src/lib/currencyCore/currencies/ext/multiFormatAddresses.tsx`
- `vite.config.ts`
- `index.html` (CSP)
- `src/main.ts` / `src/polyfills.ts` (startup wiring / polyfills iteration)

## Notes / Follow-ups
- Confirm final Solana SHA-512 wiring path aligns with installed `@noble/ed25519` API (`hashes.sha512` vs legacy `etc.sha512Sync`) and that it’s executed before SOL derivation in all runtime paths.
- Keep noble-resolution fixes scoped to avoid breaking nested dependency versions (ethers/stacks/tronweb).

